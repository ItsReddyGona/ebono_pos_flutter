name: Stage Distributor Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    ## ðŸŸ¢ Setup Environment
    - name: Checkout Code
      uses: actions/checkout@v3

    ## ðŸŸ  Install Dependencies
    - name: Update apt packages
      run: sudo apt-get update

    - name: Upgrade system packages
      run: sudo apt-get upgrade -y

    - name: Install clang
      run: sudo apt-get install -y clang

    - name: Install cmake
      run: sudo apt-get install -y cmake

    - name: Install git
      run: sudo apt-get install -y git

    - name: Install ninja-build
      run: sudo apt-get install -y ninja-build

    - name: Install pkg-config
      run: sudo apt-get install -y pkg-config

    - name: Install libgtk-3-dev
      run: sudo apt-get install -y libgtk-3-dev

    - name: Install liblzma-dev
      run: sudo apt-get install -y liblzma-dev

    - name: Install libstdc++-12-dev
      run: sudo apt-get install -y libstdc++-12-dev

    - name: Install libunwind-dev
      run: sudo apt-get install -y libunwind-dev

    - name: Install libgstreamer1.0-dev
      run: sudo apt-get install -y libgstreamer1.0-dev

    - name: Install libgstreamer-plugins-base1.0-dev
      run: sudo apt-get install -y libgstreamer-plugins-base1.0-dev

    ## ðŸ”µ Setup Flutter
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.29.0"

    - name: Install Flutter dependencies
      run: flutter pub get

    - name: Activate flutter_distributor globally
      run: dart pub global activate flutter_distributor

    ## ðŸŸ£ Build Release
    - name: Get version from pubspec.yaml
      id: version
      run: |
        VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build Stage Release
      run: flutter_distributor release --name=stage --jobs=release-stage-linux-deb

    - name: Upload Stage Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: stage-release-${{ steps.version.outputs.version }}
        path: dist/
