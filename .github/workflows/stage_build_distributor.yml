name: Stage Distributor Build

on:
  # Allow manual trigger
  workflow_dispatch:

  # Allow auto-trigger on push to the 'deployment' branch
  # push:
  #   branches:
  #     - deployment

jobs:
  # Job 1: Setup Environment
  setup:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Install system dependencies
      - name: Install required dependencies
        run: |
          sudo apt-get update && sudo apt-get upgrade -y
          sudo apt-get install -y \
            clang \
            cmake \
            git \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev \
            libunwind-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev

      # Step 3: Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1"

      # Step 4: Get version from pubspec.yaml
      - name: Get version from pubspec.yaml
        id: get_version
        run: |
          VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # Job 2: Install Flutter Dependencies
  install_dependencies:
    runs-on: ubuntu-22.04
    needs: setup
    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Install Flutter dependencies
      - name: Install Flutter dependencies
        run: flutter pub get

  # Job 3: Activate Flutter Distributor
  activate_distributor:
    runs-on: ubuntu-22.04
    needs: install_dependencies
    steps:
      # Step 1: Activate Flutter Distributor
      - name: Activate Flutter Distributor
        run: dart pub global activate flutter_distributor

  # Job 4: Build Stage Release
  build_release:
    runs-on: ubuntu-22.04
    needs: activate_distributor
    steps:
      # Step 1: Build Stage Release
      - name: Build Stage Release
        run: flutter_distributor release --name=stage --jobs=release-stage-linux-deb

      # Step 2 (Optional): Upload build artifact (deb file)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: stage-release-${{ needs.setup.outputs.version }}
          path: dist/
