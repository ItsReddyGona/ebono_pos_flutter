name: Stage Distributor Build

on:
  # Allow manual trigger
  workflow_dispatch:

  # Allow auto-trigger on push to the 'deployment' branch
  #push:
  #branches:
  #- Deployment

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-22.04
    env:
      PKG_CONFIG_PATH: /usr/lib/pkgconfig:/usr/share/pkgconfig
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Version: $VERSION"

  install_dependencies:
    name: Install Dependencies
    needs: setup
    runs-on: ubuntu-22.04
    env:
      PKG_CONFIG_PATH: /usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install base dev tools
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: clang cmake git ninja-build pkg-config
          version: 1.0

      - name: Install UI libraries
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libgtk-3-dev gtk+-3.0 pkg-config
          
      - name: Install system libraries
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: liblzma-dev libstdc++-12-dev libunwind-dev
          version: 1.0

      - name: Install media libraries
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

  setup_flutter:
    name: Setup Flutter
    needs: install_dependencies
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1"
          cache: true
          cache-key: flutter-:os:-:channel:-:version:-:arch:-:hash:-${{ hashFiles('**/pubspec.lock') }}
      
      - name: Cache pub dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install Flutter dependencies
        run: flutter pub get
        
      - name: Cache Flutter Distributor
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache/bin
          key: ${{ runner.os }}-flutter-distributor-cache
 
      - name: Activate Flutter Distributor
        run: |
          if [ ! -f ~/.pub-cache/bin/flutter_distributor ]; then
            dart pub global activate flutter_distributor
          fi

  build:
    name: Build Application
    needs: [setup, setup_flutter]
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1"
          cache: true
      
      - name: Restore Flutter Distributor cache
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache/bin
          key: ${{ runner.os }}-flutter-distributor-cache
        
      - name: Install Flutter dependencies
        run: flutter pub get
        
      - name: Verify GTK Installation
        run: |
          echo "Checking GTK installation..."
          pkg-config --modversion gtk+-3.0 || echo "GTK 3.0 not found in pkg-config"
          ls -l /usr/lib/*/pkgconfig/gtk+-3.0.pc || echo "GTK PC file not found"
          
      - name: Build Stage Release
        run: |
          export PATH="$PATH":"$HOME/.pub-cache/bin"
          export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig
          flutter config --enable-linux-desktop
          flutter doctor -v
          flutter_distributor release --name=stage --jobs=release-stage-linux-deb

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: stage-release-${{ needs.setup.outputs.version }}
          path: dist/
